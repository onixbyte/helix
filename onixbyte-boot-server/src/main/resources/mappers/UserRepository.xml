<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onixbyte.onixboot.repository.UserRepository">
    <resultMap id="BizUserWithIdentitiesResultMap" type="com.onixbyte.onixboot.dataset.biz.BizUser">
        <id property="id" column="user_id"/>
        <result property="username" column="username"/>
        <result property="fullName" column="full_name"/>
        <result property="email" column="email"/>
        <result property="countryCode" column="country_code"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="avatarUrl" column="avatar_url"/>
        <result property="status" column="user_status"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="departmentId" column="department_id"/>
        <result property="positionId" column="position_id"/>
        <collection property="userIdentities"
                    javaType="java.util.ArrayList"
                    ofType="com.onixbyte.onixboot.dataset.biz.BizUserIdentity"
        >
            <result property="userId" column="identity_user_id"/>
            <result property="provider" column="identity_provider"
                    typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
            <result property="externalId" column="identity_external_id"/>
        </collection>
    </resultMap>

    <select id="selectBizUserByIdentity" resultMap="BizUserWithIdentitiesResultMap">
        SELECT u.id           AS user_id,
               u.username,
               u.full_name,
               u.email,
               u.country_code,
               u.phone_number,
               u.avatar_url,
               u.status       AS user_status,
               u.department_id,
               u.position_id,
               ui.user_id     AS identity_user_id,
               ui.provider    AS identity_provider,
               ui.external_id AS identity_external_id
        FROM users u
                 LEFT JOIN user_identities ui ON u.id = ui.user_id
        WHERE u.id = (SELECT user_id
                      FROM user_identities
                      WHERE provider = #{provider}::IdentityProvider
                        AND external_id = #{externalId})
    </select>

    <select id="selectByUsername" resultMap="BizUserWithIdentitiesResultMap">
        SELECT u.id           AS user_id,
               u.username,
               u.full_name,
               u.email,
               u.country_code,
               u.phone_number,
               u.avatar_url,
               u.status       AS user_status,
               u.department_id,
               u.position_id,
               ui.user_id     AS identity_user_id,
               ui.provider    AS identity_provider,
               ui.external_id AS identity_external_id
        FROM users u
                 LEFT JOIN user_identities ui ON u.id = ui.user_id
        WHERE u.username = #{username};
    </select>

    <insert id="insert">
        INSERT INTO users
        <trim prefix="(" suffix=")" suffixOverrides=",">
            id,
            username,
            <if test="user.password != null and user.password != ''">password,</if>
            full_name,
            <if test="user.email != null and user.email != ''">email,</if>
            <if test="user.countryCode != null and user.countryCode != ''">country_code,</if>
            <if test="user.phoneNumber != null and user.phoneNumber != ''">phone_number,</if>
            <if test="user.avatarUrl != null and user.avatarUrl != ''">avatar_url,</if>
            <!-- For numeric types, only a null check is necessary and correct. -->
            <if test="user.departmentId != null">department_id,</if>
            <if test="user.positionId != null">position_id,</if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
            #{user.id},
            #{user.username},
            <if test="user.password != null and user.password != ''">#{user.password},</if>
            #{user.fullName},
            <if test="user.email != null and user.email != ''">#{user.email},</if>
            <if test="user.countryCode != null and user.countryCode != ''">#{user.countryCode},</if>
            <if test="user.phoneNumber != null and user.phoneNumber != ''">#{user.phoneNumber},</if>
            <if test="user.avatarUrl != null and user.avatarUrl != ''">#{user.avatarUrl},</if>
            <if test="user.departmentId != null">#{user.departmentId},</if>
            <if test="user.positionId != null">#{user.positionId},</if>
        </trim>
    </insert>

</mapper>